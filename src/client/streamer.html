<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Streaming</title>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .controls {
            margin: 20px 0;
        }
        video {
            width: 100%;
            max-width: 800px;
            border: 1px solid #ccc;
        }
        .hidden {
            display: none;
        }
        #roomUrl {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebRTC Streaming</h1>
        <div id="streamerControls" class="controls">
            <button id="startCamera">Start Camera</button>
            <button id="startScreen">Share Screen</button>
            <button id="stopStream" class="hidden">Stop Streaming</button>
            <div id="roomUrlContainer" class="hidden">
                <p>Share this URL with viewers:</p>
                <input type="text" id="roomUrl" readonly>
            </div>
        </div>
        <div id="viewerControls" class="controls hidden">
            <p>Waiting for streamer...</p>
        </div>
        <video id="localVideo" autoplay playsinline muted class="hidden"></video>
        <video id="remoteVideo" autoplay playsinline class="hidden"></video>
    </div>

    <script>
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        let peerConnection;
        let localStream;
        let isStreamer = false;
        let myClientId = null;
        let currentRoomId = null;

        const roomId = new URLSearchParams(window.location.search).get('room');

        // If no room ID is present, we're the streamer
        if (!roomId) {
            isStreamer = true;
            document.getElementById('streamerControls').style.display = 'block';
            document.getElementById('viewerControls').style.display = 'none';
        } else {
            isStreamer = false;
            document.getElementById('streamerControls').style.display = 'none';
            document.getElementById('viewerControls').style.display = 'block';
        }

        const ws = new WebSocket('ws://localhost:3000');

        ws.onopen = () => {
            console.log('Connected to signaling server');
        };

        ws.onmessage = async (event) => {
            const message = JSON.parse(event.data);
            console.log('Received message:', message);

            switch (message.type) {
                case 'welcome':
                    myClientId = message.clientId;
                    if (isStreamer) {
                        // Crear una sala nueva para el streamer
                        ws.send(JSON.stringify({
                            type: 'join',
                            roomId: myClientId
                        }));
                    } else if (roomId) {
                        // El viewer se une a la sala existente
                        ws.send(JSON.stringify({
                            type: 'join',
                            roomId: roomId
                        }));
                    }
                    break;

                case 'joined':
                    currentRoomId = message.roomId;
                    if (isStreamer) {
                        const url = `${window.location.origin}${window.location.pathname}?room=${currentRoomId}`;
                        document.getElementById('roomUrl').value = url;
                        document.getElementById('roomUrlContainer').classList.remove('hidden');
                    } else {
                        initializeViewer();
                        // Solicitar la oferta al streamer
                        ws.send(JSON.stringify({
                            type: 'requestOffer',
                            roomId: currentRoomId
                        }));
                    }
                    break;

                case 'userJoined':
                    if (isStreamer && localStream) {
                        // Reiniciar la conexiÃ³n cuando un nuevo viewer se une
                        initializeStreamer();
                    }
                    break;

                case 'offer':
                    if (!isStreamer) {
                        await handleOffer(message.data);
                    }
                    break;

                case 'answer':
                    if (isStreamer && peerConnection) {
                        try {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(message.data));
                        } catch (e) {
                            console.error('Error setting remote description:', e);
                        }
                    }
                    break;

                case 'ice-candidate':
                    if (peerConnection) {
                        try {
                            await peerConnection.addIceCandidate(new RTCIceCandidate(message.data));
                        } catch (e) {
                            console.error('Error adding ice candidate:', e);
                        }
                    }
                    break;
            }
        };

        async function startStream(mediaType) {
            try {
                if (mediaType === 'camera') {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                } else {
                    localStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true
                    });
                }

                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('localVideo').classList.remove('hidden');
                document.getElementById('startCamera').classList.add('hidden');
                document.getElementById('startScreen').classList.add('hidden');
                document.getElementById('stopStream').classList.remove('hidden');

                await initializeStreamer();
            } catch (error) {
                console.error('Error accessing media devices:', error);
            }
        }

        async function initializeStreamer() {
            if (peerConnection) {
                peerConnection.close();
            }
            
            peerConnection = new RTCPeerConnection(configuration);
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'ice-candidate',
                        data: event.candidate,
                        roomId: currentRoomId
                    }));
                }
            };

            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                ws.send(JSON.stringify({
                    type: 'offer',
                    data: offer,
                    roomId: currentRoomId
                }));
            } catch (e) {
                console.error('Error creating offer:', e);
            }
        }

        async function initializeViewer() {
            if (peerConnection) {
                peerConnection.close();
            }

            peerConnection = new RTCPeerConnection(configuration);

            peerConnection.ontrack = (event) => {
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    remoteVideo.classList.remove('hidden');
                    document.getElementById('viewerControls').textContent = 'Connected to stream';
                }
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'ice-candidate',
                        data: event.candidate,
                        roomId: currentRoomId
                    }));
                }
            };
        }

        async function handleOffer(offer) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                ws.send(JSON.stringify({
                    type: 'answer',
                    data: answer,
                    roomId: currentRoomId
                }));
            } catch (e) {
                console.error('Error handling offer:', e);
            }
        }

        function stopStream() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                document.getElementById('localVideo').srcObject = null;
                document.getElementById('localVideo').classList.add('hidden');
                document.getElementById('startCamera').classList.remove('hidden');
                document.getElementById('startScreen').classList.remove('hidden');
                document.getElementById('stopStream').classList.add('hidden');
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
        }

        document.getElementById('startCamera').addEventListener('click', () => startStream('camera'));
        document.getElementById('startScreen').addEventListener('click', () => startStream('screen'));
        document.getElementById('stopStream').addEventListener('click', stopStream);
    </script>
</body>
</html>